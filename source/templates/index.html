<!-- templates/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>LeibnizDream WhisperX</title>
</head>
<body>
  <h1>LeibnizDream TGT</h1>
  <form id="theForm">
    <label>Language:
      <input type="text" name="language" value="German" required>
    </label>
    <label>Verbose:
      <input type="checkbox" name="verbose">
    </label>
    <br><br>
    <label>Upload Session Folder:</label><br>
    <input
      type="file"
      name="folder"
      webkitdirectory
      directory
      multiple
      required
    ><br><br>
    <button type="submit">Process &amp; Download</button>
  </form>

  <div id="status"></div>

  <script>
  document.getElementById('theForm').onsubmit = async e => {
    e.preventDefault();
    const status = document.getElementById('status');
    status.textContent = 'Processingâ€¦ This may take a while.';

    const data = new FormData(e.target);
    try {
      const res = await fetch('/process', {
        method: 'POST',
        body: data
      });
      if (!res.ok) {
        const err = await res.json();
        status.textContent = 'Error: ' + err.error;
        return;
      }

      // grab filename from Content-Disposition header
      const cd = res.headers.get('Content-Disposition') || '';
      const match = /filename="?(.+)"?/.exec(cd);
      const filename = match ? match[1] : 'output';

      // download the blob
      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      status.textContent = 'Done! Download should begin shortly.';
    } catch (err) {
      status.textContent = 'Network error: ' + err;
    }
  };
  </script>
</body>
</html>