{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LeibnizDream Transcription App</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
<div class="container">
    <div class="sidebar">
        <h2 class="title">Automatic Workflow – LeibnizDream</h2>

        <!-- OneDrive Connect -->
        <button id="btn-connect" class="btn-secondary" type="button">Connect OneDrive</button>

        <form id="form-transcribe">
            <label for="action">Action</label>
            <select id="action" name="action" required>
                <option value="transcribe">Transcribe</option>
                <option value="translate">Translate</option>
                <option value="gloss">Gloss</option>
            </select>

            <label for="base-dir">Directory Path</label>
            <input type="text" id="base-dir" name="base_dir" placeholder="OneDrive share link" required>

            <label for="instruction">Instruction</label>
            <select id="instruction" name="instruction" required>
                <option value="corrected">corrected</option>
                <option value="automatic">automatic</option>
                <option value="sentences">sentences</option>
            </select>

            <label for="language">Language</label>
            <input type="text" id="language" name="language" value="German" required>

            <button id="btn-process" class="btn-primary" type="button" disabled>Start</button>
            <button id="btn-cancel" class="btn-secondary" type="button" style="display:none;">Cancel</button>

            <div id="status" class="status"></div>
        </form>
    </div>

    <div class="main">
        <img src="{% static 'zas_logo.jpg' %}" alt="Logo" class="logo">
        <p class="logo-text">LeibnizDream</p>
        <pre id="logs"></pre>
    </div>
</div>

<script>
    const connectBtn = document.getElementById('btn-connect');
    const processBtn = document.getElementById('btn-process');
    const cancelBtn  = document.getElementById('btn-cancel');
    const statusEl   = document.getElementById('status');
    const logEl      = document.getElementById('logs');
    let accessToken  = null;
    let currentJobId = null;
  
    // 1️⃣ Connect OneDrive → open popup
    connectBtn.addEventListener('click', () => {
      const popup = window.open('/auth/start', 'authPopup', 'width=600,height=700');
  
      const checkPopupClosed = setInterval(() => {
        if (popup.closed) {
          clearInterval(checkPopupClosed);
          // 2️⃣ Try to fetch access token from server session
          fetch('/auth/token')
            .then(res => res.json())
            .then(data => {
              if (data.access_token) {
                accessToken = data.access_token;
                connectBtn.style.display = 'none';
                processBtn.disabled = false;
                statusEl.textContent = 'OneDrive connected.';
              } else {
                alert("Could not retrieve access token.");
              }
            });
        }
      }, 500);
    });
  
    // 3️⃣ Start processing
    processBtn.addEventListener('click', async () => {
      if (!accessToken) {
        alert('Please connect OneDrive first');
        return;
      }
  
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      const formData = new FormData(document.getElementById('form-transcribe'));
      formData.append('access_token', accessToken);
  
      processBtn.style.display = 'none';
      cancelBtn.style.display  = 'inline-block';
      logEl.textContent        = '';
      statusEl.textContent     = 'Job starting...';
  
      const res = await fetch('/process/', {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': csrfToken },
        credentials: 'same-origin'
      });
  
      const data = await res.json();
      if (!res.ok || data.error) {
        statusEl.textContent = data.error || 'Failed to start job.';
        processBtn.style.display = 'inline-block';
        cancelBtn.style.display  = 'none';
        return;
      }
  
      currentJobId = data.job_id;
      statusEl.textContent = 'Job ' + currentJobId + ' started.';
      startLogStream(currentJobId);
    });

    // 4️⃣ Poll logs
    let evt = null;
    
    function startLogStream(jobId) {
        evt = new EventSource(`/logs/${jobId}`);
        evt.onmessage = e => {
            if (e.data == '[PING]') return;
            logEl.textContent += e.data + "\n";
            logEl.scrollTop = logEl.scrollHeight;
            if (e.data === "[DONE ALL]" || e.data === "[CANCELLED]" || e.data.startsWith("[ERROR]")) {
                evt.close();
                localStorage.removeItem("job_id");
                document.getElementById("btn-cancel").style.display = "none";
                statusEl.textContent = "Finished.";
            }
        };

        evt.onerror = e => { 
            console.error("EventSource error:", e);
            evt.close();
            localStorage.removeItem("job_id");
            document.getElementById("btn-cancel").style.display = "none";
            document.getElementById("btn-process").style.display = "block";
            logEl.textContent += "[ERROR] Error occurred. Job not finished";
            statusEl.textContent = "Error occurred. Job not finished";
        };

    }
  
    // 5️⃣ Cancel job
    cancelBtn.addEventListener('click', async () => {
      if (!currentJobId) return;
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      await fetch(`/cancel/${currentJobId}`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        credentials: 'same-origin'
      });
      statusEl.textContent = 'Cancelling...';
    });
  </script>
  
  
  
</body>
</html>