{% load static %}
{% csrf_token %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transcription App</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
<div class="container">
    <div class="sidebar"> 
        <h2 class="title">Automatic workflow LeibnizDream</h2>
        <form id="form-transcribe">
            <label for="action">Action</label>
            <select id="action" name="action" required>
                <option value="transcribe">Transcribe</option>
                <option value="translate">Translate</option>
                <option value="gloss">Gloss</option>
            </select>
        
            <label>Directory Path</label>
            <input type="text" id="base-dir" name="base_dir" placeholder="/path/to/dir" required>
        
            <label for="instruction">Instruction</label>
            <select id="instruction" name="instruction" required>
                <option value="corrected">corrected</option>
                <option value="automatic">automatic</option>
                <option value="sentences">sentences</option>
            </select>
        
            <label>Language</label>
            <input type="text" id="language" name="language" value="German" required>
        
            <!-- ðŸ’¥ Just buttons stacked -->
            <button id="btn-process" class="btn-primary" type="button">Start</button>
            <button id="btn-cancel" class="btn-secondary" type="button" style="display:none;">Cancel</button>
        
            <div id="status" class="status"></div>
        </form>
    </div>

    <div class="main">
        <img src="{% static 'zas_logo.jpg' %}" alt="Logo" class="logo">
        <p class="logo-text">LeibnizDream</p>
        <pre id="logs"></pre>
    </div>
</div>

<script>
    let currentJobId = null;
    let pollInterval = null;
  
    async function fetchLogs(jobId) {
      try {
        const res = await fetch(`/logs/${jobId}/`);
        if (!res.ok) throw new Error("Log fetch failed");
        return await res.text();
      } catch (err) {
        console.error(err);
        return null;
      }
    }
  
    function startPolling(jobId) {
      const statusEl = document.getElementById("status");
      const logEl    = document.getElementById("logs");
      logEl.textContent = "";
  
      // poll every 1.5s (1500ms)
      pollInterval = setInterval(async () => {
        const text = await fetchLogs(jobId);
        if (text === null) return;
  
        logEl.textContent = text;
        logEl.scrollTop   = logEl.scrollHeight;
  
        // stop when we see a terminal marker
        if (
          text.includes("[DONE ALL]") ||
          text.includes("[CANCELLED]") ||
          text.includes("[ERROR]")
        ) {
          clearInterval(pollInterval);
          document.getElementById("btn-cancel").style.display = "none";
          statusEl.textContent = "Finished.";
        }
      }, 1500);
    }
  
    document.getElementById("btn-process").onclick = async () => {
      const base        = document.getElementById("base-dir").value.trim();
      const language    = document.getElementById("language").value.trim();
      const action      = document.getElementById("action").value;
      const instruction = document.getElementById("instruction").value;
      const csrfToken   = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      const statusEl    = document.getElementById("status");
  
      const payload = new FormData();
      payload.append("base_dir", base);
      payload.append("language", language);
      payload.append("action", action);
      payload.append("instruction", instruction);
  
      let data;
      try {
        const res = await fetch("/process/", {
          method: "POST",
          body: payload,
          headers: { "X-CSRFToken": csrfToken },
          credentials: "same-origin",
        });
        if (!res.ok) throw new Error("Start failed");
        data = await res.json();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to start job.";
        return;
      }
  
      if (data.error || !data.job_id) {
        statusEl.textContent = data.error || "Job ID missing.";
        return;
      }
  
      currentJobId = data.job_id;
      localStorage.setItem("job_id", currentJobId);
      document.getElementById("btn-process").style.display = "none";
      document.getElementById("btn-cancel").style.display  = "block";
      statusEl.textContent = "Job " + currentJobId + " started";
  
      startPolling(currentJobId);
    };
  
    document.getElementById("btn-cancel").onclick = async () => {
      if (!currentJobId) return;
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      try {
        await fetch(`/cancel/${currentJobId}`, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken },
          credentials: "same-origin",
        });
        document.getElementById("status").textContent = "Cancelling...";
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "Failed to cancel.";
      }
    };
  
    // on load, resume polling if a job was in progress
    window.addEventListener("load", () => {
      const saved = localStorage.getItem("job_id");
      if (saved) {
        currentJobId = saved;
        document.getElementById("btn-process").style.display = "none";
        document.getElementById("btn-cancel").style.display  = "block";
        document.getElementById("status").textContent     = "Reconnected to job " + saved;
        startPolling(saved);
      }
    });
  </script>
</body>
</html>
