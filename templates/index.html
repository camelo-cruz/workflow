{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transcription App</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2 class="title">Automatic workflow LeibnizDream</h2>

    <!-- Mode -->
    <div class="mode-selector">
      <label><input type="radio" name="mode" value="online" checked> Work Online</label>
      <label><input type="radio" name="mode" value="upload"> Upload Files</label>
    </div>

    <!-- Online -->
    <div id="online-ui">
      <button id="btn-connect" class="btn-secondary">Connect OneDrive</button>
      <input type="text" id="manual-token" placeholder="Paste access token here" style="display:none; width:100%;">
      <button id="btn-set-token" class="btn-primary" style="display:none;">Use Token</button>

      <label for="remote-base-dir">Directory Path</label>
      <input type="text" id="remote-base-dir" name="base_dir" placeholder="/share-link-or-path" required>
    </div>

    <!-- Offline -->
    <div id="upload-ui" style="display:none; margin-top:1em;">
      <button id="btn-upload-folder" class="btn-secondary" type="button" style="margin-top:0.5em;">Select Folder</button>
      <input type="file" id="file-input" webkitdirectory directory multiple style="display:none;" />

    </div>

    <!-- Form -->
    <form id="form-transcribe">
      <label for="action">Action</label>
      <select id="action" name="action" required>
        <option value="transcribe">Transcribe</option>
        <option value="translate">Translate</option>
        <option value="gloss">Gloss</option>
        <option value="create columns">Create columns</option>
      </select>

      <label for="instruction">Instruction</label>
      <select id="instruction" name="instruction" required>
        <option value="corrected">corrected</option>
        <option value="automatic">automatic</option>
        <option value="sentences">sentences</option>
      </select>

      <label for="language">Language</label>
      <input type="text" id="language" name="language" value="German" required>

      <button id="btn-process" class="btn-primary" type="button" disabled>Start</button>
      <button id="btn-cancel" class="btn-secondary" type="button" hidden style="margin-left:0.5em;">Cancel</button>

      <div id="status" class="status"></div>
      <progress id="upload-progress" value="0" max="100" style="display:none; width:100%;"></progress>
    </form>
  </div>

  <div class="main">
    <img src="{% static 'zas_logo.jpg' %}" alt="Logo" class="logo">
    <p class="logo-text">LeibnizDream</p>
    <pre id="logs"></pre>
  </div>
</div>


<script>
  const modeRadios = document.querySelectorAll('input[name="mode"]');
  const onlineUI   = document.getElementById('online-ui');
  const connectBtn = document.getElementById('btn-connect');
  const manualInput = document.getElementById('manual-token');
  const setTokenBtn = document.getElementById('btn-set-token');
  const remoteBaseDir = document.getElementById('remote-base-dir');
  const uploadUI   = document.getElementById('upload-ui');
  const fileInput  = document.getElementById('file-input');
  const btnUpload  = document.getElementById('btn-upload-folder');
  const btnProcess = document.getElementById('btn-process');
  const btnCancel  = document.getElementById('btn-cancel');
  const statusEl   = document.getElementById('status');
  const progressEl = document.getElementById('upload-progress');
  const form       = document.getElementById('form-transcribe');
  
  let uploadFiles = [], accessToken = null, jobId = null, evt = null;


  // Selecting processing mode
  function onModeChange() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  isOffline = (mode === 'upload');
  onlineUI.style.display = isOffline ? 'none' : 'block';
  uploadUI.style.display = isOffline ? 'block' : 'none';
  btnProcess.disabled = isOffline ? uploadFiles.length === 0 : !accessToken || !remoteBaseDir.value;
  }
  modeRadios.forEach(r => r.addEventListener('change', onModeChange));

  window.addEventListener("load", () => {
  jobId       = localStorage.getItem("job_id");
  accessToken = localStorage.getItem("access_token");
  const logs  = localStorage.getItem("logs");
  if (logs) {
    document.getElementById("logs").textContent = logs;
  }
  if (jobId) {
    openStream();
  }
});
  
  btnUpload.onclick = ()=> fileInput.click();
  fileInput.onchange = ()=>{
    uploadFiles = Array.from(fileInput.files);
    console.log("Picked:", uploadFiles.map(f=>f.webkitRelativePath));
    btnProcess.disabled = !uploadFiles.length;
  };

  // Connecting to OneDrive
  connectBtn.addEventListener('click', () => {
  manualInput.style.display = 'none';
  setTokenBtn.style.display = 'none';
  const popup = window.open('/auth/start', 'authPopup', 'width=600,height=700');
  if (!popup) return showManualFallback();
  const timer = setInterval(() => {
    if (!popup || popup.closed) {
      clearInterval(timer);
      fetch('/auth/token', { credentials: 'same-origin' })
        .then(r => r.json())
        .then(body => {
          if (body.access_token) setToken(body.access_token);
          else showManualFallback();
        })
        .catch(showManualFallback);
    }
  }, 500);
});

setTokenBtn.addEventListener('click', () => {
  const t = manualInput.value.trim();
  if (!t) return alert('Please paste a valid token.');
  setToken(t);
});

function showManualFallback() {
  statusEl.textContent = 'Authentication failed – paste your token';
  manualInput.style.display = 'block';
  setTokenBtn.style.display = 'block';
}

function setToken(token) {
  accessToken = token;
  localStorage.setItem('access_token', token);
  connectBtn.style.display = 'none';
  manualInput.style.display = 'none';
  setTokenBtn.style.display = 'none';
  btnProcess.disabled = false;
  statusEl.textContent = 'OneDrive connected.';
}

// Processing logic
  btnProcess.onclick = async ()=>{
    btnProcess.hidden = true;
    btnCancel.hidden = false;
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const data = new FormData();
    data.append("action", document.getElementById('action').value);
    data.append("instruction", document.getElementById('instruction').value);
    data.append("language", document.getElementById('language').value);
  
    if (mode==='online') {
      data.append("base_dir", document.getElementById('remote-base-dir').value);
      data.append("access_token", accessToken);
      // normal fetch
      const res = await fetch("/process/",{method:"POST",body:data,credentials:"same-origin"});
      const js  = await res.json();
      jobId = js.job_id;
      localStorage.setItem("job_id", jobId);
      openStream();
    } else {
      // ZIP client-side
      statusEl.textContent = "Zipping…";
      const zip = new JSZip();
      uploadFiles.forEach(f=> zip.file(f.webkitRelativePath, f));
      const blob = await zip.generateAsync({type:"blob"}, meta=>{
        progressEl.hidden = false;
        progressEl.value  = meta.percent;
        statusEl.textContent = `Zipping ${Math.round(meta.percent)}%`;
      });
      data.append("zipfile", blob, "upload.zip");
  
      // upload ZIP
      statusEl.textContent = "Uploading…";
      const xhr = new XMLHttpRequest();
      xhr.open("POST","/process/"); xhr.withCredentials=true;
      xhr.upload.onprogress = e=>{
        if(e.lengthComputable){
          progressEl.value = (e.loaded/e.total)*100;
          statusEl.textContent = `Uploading… ${Math.round(progressEl.value)}%`;
        }
      };
      xhr.onload = ()=>{
        const js=JSON.parse(xhr.responseText);
        jobId=js.job_id;
        localStorage.setItem("job_id", jobId);
        openStream();
      };
      xhr.send(data);
    }
  };
  
  function openStream() {
  btnProcess.hidden = true;
  btnCancel.hidden = false;
  progressEl.hidden = true;
  statusEl.textContent = `Job ${jobId}`;
  evt = new EventSource(`/stream/${jobId}/`);

  evt.onmessage = (e) => {
    const msg = e.data;
    if (msg === "[PING]") return;

    document.getElementById('logs').textContent += msg + "\n";

    // Handle server messages
    if (msg.includes("[DONE ALL]") || msg.includes("[ERROR]")) {
      statusEl.textContent = "Done all!";
      finishStream();  // Call cleanup and download
    }
  };

  function finishStream() {
    evt.close();
    btnCancel.hidden = true;
    btnProcess.hidden = false;
    localStorage.removeItem("job_id");
    localStorage.removeItem("logs");

    if (document.querySelector('input[name="mode"]:checked').value === 'upload') {
      fetch(`download/${jobId}/`)
        .then(r => {
          if (!r.ok) throw new Error("Download failed");
          return r.blob();
        })
        .then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${jobId}_results.zip`;
          document.body.append(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        })
        .catch(err => console.error("Download failed:", err));
    }
  }
}
  
  btnCancel.onclick = async ()=>{
    await fetch("/cancel/",{method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({job_id:jobId}),credentials:"same-origin"});
    evt.close();
    statusEl.textContent="Cancelled";
    btnCancel.hidden=true; btnProcess.hidden=false;
  };
  </script>
  </body>
  </html>